---
layout  : wiki
title   : RaspberryPi4 스트림서버 설정 
summary : 
date    : 2022-06-20 01:45:52 +0900
updated : 2022-06-20 07:08:27 +0900
tags    : 
toc     : true
public  : true
parent  : 
latex   : false
---
* TOC
{:toc}

### OS설치
* gstreamer 에서 사용하는 인코더 라이브러리 문제로 32비트 설치
```bash
$ wget https://downloads.raspberrypi.org/raspios_armhf/images/raspios_armhf-2022-04-07/2022-04-04-raspios-bullseye-armhf.img.xz
$ xz -d ./2022-04-04-raspios-bullseye-armhf.img.xz
$ sudo dd if=./2022-04-04-raspios-bullseye-armhf.img of=/dev/sdb bs=4M conv=fsync status=progress
```
* 설치한 MicroSD로 부팅 후 업데이트(인코더 라이브러리가 이때 설치됨 - /opt/vc/)
```bash
$ sudo apt update
$ sudo rpi-update
```

### 영상스트리밍
* 구조
  * 4K Action캠 -- HDMI -- USB -- Rasp4_B/D -- eth0 -- 영상송신
* 카메라선정
* 스트림서버(Rasp4_B)
  * gst-rtsp-server 
  * v4l2rtspserver
  ```bash
  $ git clone https://github.com/mpromonet/v4l2rtspserver.git
  $ cd v4l2rtspserver
  $ mkdir build && cd build
  $ cmake .. && make
  $ sudo ./rtspserver -F 30 -W 1920 -H 1080 -P 8554 /dev/video0
  ```
* 재생(클라이언트PC)
  * vlc
  ```bash
  $ sudo vlc --rtsp-tcp rtsp://x.x.x.x:8554/unicast
  ```
  * gstreamer
* H.264 
* H.265 

### 음성통화
* Rasp4_B
  * 오디오입력장치
  ```bash
  $ arecord -l
  $ arecord -f S16_LE -c 2 -r 44100 hw:1,0 test.wav
  ```
  * 오디오출력장치
  ```bash
  $ aplay -l
  $ aplay -f S16_LE -c 2 -r 44100 hw:1,0 test.wav
* ```
  * 서비스프로그램(VoIP)
* 클라이언트PC
  * 오디오입력장치
  ```bash
  $ arecord -l
  $ arecord -f S16_LE -c 2 -r 44100 hw:1,0 test.wav
  ```
  * 오디오출력장치
  ```bash
  $ aplay -l
  $ aplay -f S16_LE -c 2 -r 44100 hw:1,0 test.wav
  ```
  * 서비스프로그램(VoIP)
    * 다운로드
    ```bash
    $ git clone https://github.com/SFML/SFML.git
    ```
    * CMakeLists.txt 수정
    ```bash
    $ cd SFML.git
    $ vim ./CMakeLists.txt
    $ echo "set(SFML_OS_LINUX TRUE)\nset(SFML_BUILD_EXAMPLES TRUE)" >> ./CMakeLists.txt
    ```
    * 컴파일
    ```bash
    $ mkdir build && cd build && cmake .. && make
    ```

### 모니터링
* 포트
```bash
$ watch -n2 "netstat -tulpn"
```
* 데이터 전송률
```bash
$ sudo vnstat -i eth0 -l
```
