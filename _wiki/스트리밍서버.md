---
layout  : wiki
title   : RaspberryPi4 스트림서버 설정 
summary : 
date    : 2022-06-20 01:45:52 +0900
updated : 2022-06-21 08:47:01 +0900
tags    : 
toc     : true
public  : true
parent  : 
latex   : false
---
* TOC
{:toc}

### OS설치
* gstreamer 에서 사용하는 인코더 라이브러리 문제로 32비트 설치
```bash
$ wget https://downloads.raspberrypi.org/raspios_armhf/images/raspios_armhf-2022-04-07/2022-04-04-raspios-bullseye-armhf.img.xz
$ xz -d ./2022-04-04-raspios-bullseye-armhf.img.xz
$ sudo dd if=./2022-04-04-raspios-bullseye-armhf.img of=/dev/sdb bs=4M conv=fsync status=progress
```
* 설치한 MicroSD로 부팅 후 업데이트(인코더 라이브러리가 이때 설치됨 - /opt/vc/)
```bash
$ sudo apt update
$ sudo rpi-update
```

### 영상스트리밍
* 구조
4K Action캠 -- HDMI -- USB -- Rasp4_B/D -- eth0 -- 영상송신
* 카메라선정
* 스트림서버(Rasp4_B)
  * [Install GStreamer 1.18 on Raspberry Pi 4](https://qengineering.eu/install-gstreamer-1.18-on-raspberry-pi-4.html) 를 참고로 작성
  * gstreamer-1.0
    * receiver
    먼저 실행시킨다.
    ```bash
    sudo gst-launch-1.0 -v udpsrc port=5000 ! application/x-rtp, encoding-name=H264 ! rtph264depay ! avdec_h264 ! videoconvert ! autovideosink
    ```
    * sender
    카메라 지원 사양을 확인한다.
    ```bash
    v4l2-ctl --device=/dev/video0 -D --list-formats-ext
    ```
    나중에 실행시킨다.
    ```bash
    sudo gst-launch-1.0 -v libcamerasrc !
    video/x-raw,width=800,height=600,framerate=20/1 ! videoconvert ! x264enc
    tune=zerolatency byte-stream=true ! h264parse config-interval=1 ! rtph264pay
    name=pay0 pt=96 ! udpsink host="client's ip address" port=5000
    ```
  * gst-rtsp-server 
    * build 
    * sender
    * receiver
  * v4l2rtspserver
    * build 
    ```bash
    $ git clone https://github.com/mpromonet/v4l2rtspserver.git
    $ cd v4l2rtspserver
    $ mkdir build && cd build
    $ cmake .. && make
    * sender
    이 경우 USB CAM에서 전송되는 MPEG 영상을 전송(약 40Mbps)
    ```bash
    $ git clone https://github.com/mpromonet/v4l2rtspserver.git
    $ cd v4l2rtspserver
    $ mkdir build && cd build
    $ cmake .. && make
    $ sudo ./rtspserver -F 30 -W 1920 -H 1080 -P 8554 /dev/video0
      ```
    * receiver
    ```bash
    $ sudo vlc --rtsp-tcp rtsp://x.x.x.x:8554/unicast
    ```
* H.264 
* H.265 
  * HW Encoder를 지원하지 않음 - .[raspberry pi 4 h.265 hardware accelerate encode](https://forums.raspberrypi.com/viewtopic.php?t=243873)

### 음성통화
* Rasp4_B
  * 오디오입력장치
  ```bash
  $ arecord -l
  $ arecord -f S16_LE -c 2 -r 44100 hw:1,0 test.wav
  ```
  * 오디오출력장치
  ```bash
  $ aplay -l
  $ aplay -f S16_LE -c 2 -r 44100 hw:1,0 test.wav
  ```
  * 서비스프로그램(VoIP)
* 클라이언트PC
  * 오디오입력장치
  ```bash
  $ arecord -l
  $ arecord -f S16_LE -c 2 -r 44100 hw:1,0 test.wav
  ```
  * 오디오출력장치
  ```bash
  $ aplay -l
  $ aplay -f S16_LE -c 2 -r 44100 hw:1,0 test.wav
  ```
  * 서비스프로그램(VoIP)
   * 다운로드
  ```bash
  $ git clone https://github.com/SFML/SFML.git
  ```
   * CMakeLists.txt 수정
  ```bash
  $ cd SFML.git
  $ vim ./CMakeLists.txt
  $ echo "set(SFML_OS_LINUX TRUE)\nset(SFML_BUILD_EXAMPLES TRUE)" >> ./CMakeLists.txt
  ```
   * examples/voip/CMakeLists.txt 수정
      diff --git a/examples/voip/CMakeLists.txt b/examples/voip/CMakeLists.txt
      index a5e14c3f..d39c4aff 100644
      --- a/examples/voip/CMakeLists.txt
      +++ b/examples/voip/CMakeLists.txt
      @@ -9,4 +9,5 @@ set(SRC ${SRCROOT}/VoIP.cpp
      # define the voip target
      sfml_add_example(voip
                        SOURCES ${SRC}
      -                 DEPENDS SFML::Audio SFML::Network)
      +                 DEPENDS SFML::Audio SFML::Network
      +                 PUBLIC stdc++fs)

### 모니터링
* 포트
```bash
$ watch -n2 "netstat -tulpn"
```
* 데이터 전송률
```bash
$ sudo vnstat -i eth0 -l
```

#### 참고
[1]:https://qengineering.eu/install-gstreamer-1.18-on-raspberry-pi-4.html
[2]:https://forums.raspberrypi.com/viewtopic.php?t=243873
